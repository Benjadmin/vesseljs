<!-- @MrEranwe @EliasHasle -->
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Ship visualization with specification</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <!-- jQuery Version 1.11.1 -->
    <script src="js/libs/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/libs/bootstrap.min.js"></script> 
	
	<!-- D3JavaScript -->
	<script src="js/libs/d3_v4.9.1.js"></script>
	
	<!-- Three script -->
    <script src="js/libs/three.js"></script>
	<script src="js/libs/STLLoader.js"></script>
    <script src='js/libs/OrbitControls.js'></script>

	<!--Import library-->
	<script src="../build/Vessel.js"></script>

	<!-- Prettyprinting of JSON data -->
	<script type="text/javascript" src="js/libs/renderjson.js"></script>
	
	<!--Ship3D class for three.js-->
	<script src="js/Ship3D.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/js/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/js/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse">
        <div class="container">
            <!-- Add  the <div>[Something]</div> structure for each header in the navbar-->
            <div class="navbar-header">               
                <a class="navbar-brand" href="https://github.com/hmgaspar/shipjs">Github project page</a>
            </div>
            <!-- This is for the right part of the navbar. Reserved for Shiplab logo-->
            <div class="nav navbar-nav navbar-right">
                <div class="navbar-header">
                    <a class="navbar-brand" href="http://www.shiplab.hials.org/"><img src="images/barquinho.png" alt="Shiplab logo" style="height:150%"> 
                    </a>                    
                </div>
            </div>
        </div>
    </nav>
            
    <!-- Container creates the space -->
    <div class="container">
        
        <!-- Row creates horizontal groups of columns -->
        <div class="row">
            
            <!-- choose horizontal layout in https://www.w3schools.com/bootstrap/bootstrap_grid_examples.asp-->
            
            <!-- No divisions in page. Only 1 column. -->
             <div class="col-md-12 text-center">
                <h2>Ship as object</h2>
            </div>  
            
			<div class="col-md-12 text-center">
                
                <!-- Link the GitHub page if you have one. Add a pdf of how the project works if necessary. Just put it inside the same folder and call it how_to.pdf -->
                <!--<h1>Ship as Object</h1>-->
                <p>This app asks for a JSON file 
                and gives back the pretty form of the JSON element. It also plots a 3D image of the ship. Sample data is loaded at startup.</p>
				                                    
				<p>Developed by: Elias Hasle, Vicente Alejandro Iváñez Encinas and Henrique M. Gaspar. Visualization made using three.js.</p>

            </div>
			
            <div class="col-md-12 text-left">
                <h2>Input</h2>
                <input type="file" id="file-input" />
                <h3>Contents of the file:</h3>
                <pre id="file-content"></pre>
                <br>
            </div>
            
            <div class="col-md-12 text-left">
                <h2>3D orbit view of hull and parts</h2>
			</div>
			<div id="3d" class="col-md-12 text-left" style="min-height: 80vh">
            </div>
            
            <div class="col-md-12 text-left">
                <h2>Calculations</h2>
                <h3>GM : <span id="GMc"></span>m.</h3>
                
			</div>
            <div class="col-md-12 text-left">
                <h2>Comparation</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Variable</th>
                            <th>Hand value</th>
                            <th>Calculated value</th>                      
                            <th>% diff</th>                 
                        </tr>
                    
                    </thead>
                    <body>
                        <tr>
                           <td>Draft Amidships (m)</td> 
                           <td><span id = "draftms"></span></td> 
                           <td><span id = "draftc"></span></td> 
                           <td><span id = "draftd"></span></td> 
                        </tr>
                        <tr>
                           <td>Draft at FP (m)</td> 
                           <td><span id = "draftfp"></span></td> 
                           <td></td> 
                           <td></td> 
                        </tr>
                        <tr>
                           <td>Draft AP (m)</td> 
                           <td><span id = "draftap"></span></td> 
                           <td></td> 
                           <td></td> 
                        </tr>
                        <tr>
                           <td>Displacement (t)</td> 
                           <td><span id = "disp"></span></td> 
                            <td><span id = "dispc"></span></td> 
                           <td></td> 
                        </tr>
                        <tr>
                           <td>Waterline Lenght (m)</td> 
                           <td><span id = "lwl"></span></td> 
                           <td><span id = "lwlc"></span></td> 
                           <td><span id = "lwld"></span></td> 
                        </tr>
                        <tr>
                           <td>Maximum Waterline Breath (m)</td> 
                           <td><span id = "bwl"></span></td> 
                           <td><span id = "bwlc"></span></td> 
                           <td><span id = "bwld"></span></td> 
                        </tr>
                        <tr>
                           <td>Wetted area (m2)</td> 
                           <td><span id = "Awet"></span></td> 
                           <td></td> 
                           <td></td> 
                        </tr>
                        <tr>
                           <td>Waterplane Area (m2)</td> 
                           <td><span id = "Awp"></span></td> 
                           <td><span id = "Awpc"></span></td> 
                           <td><span id = "awpd"></span></td> 
                        </tr>
                        <tr>
                           <td>Cb</td> 
                           <td><span id = "Cb"></span></td> 
                           <td><span id = "cbc"></span></td> 
                           <td></td> 
                        </tr>
                        <tr>
                           <td>LCBx (m)</td> 
                           <td><span id = "LCBx"></span></td> 
                           <td></td> 
                           <td></td> 
                        </tr>
                        <tr>
                           <td>LCFx (m)</td> 
                           <td><span id = "LCFx"></span></td> 
                           <td></td> 
                           <td></td> 
                        </tr>
                        <tr>
                           <td>KB (m)</td> 
                           <td><span id = "KB"></span></td> 
                           <td><span id = "KBc"></span></td> 
                           <td><span id = "KBd"></span></td> 
                        </tr>
                        <tr>
                           <td>KG (m)</td> 
                           <td><span id = "KG"></span></td> 
                           <td><span id = "KGc"></span></td> 
                           <td><span id = "KGd"></span></td> 
                        </tr>
                        <tr>
                           <td>BM (m)</td> 
                           <td><span id = "BM"></span></td> 
                           <td><span id = "BMc"></span></td> 
                           <td><span id = "BMd"></span></td> 
                        </tr>
                        <tr>
                           <td>GM (m)</td> 
                           <td><span id = "GM"></span></td> 
                           <td><span id = "GM2"></span><td>
                           <td><span id = "GMd"></span></td> 
                        </tr>
                         <tr>
                           <td>Lightweigth (kg)</td> 
                           <td><span id = "lightweight"></span></td> 
                           <td><span id = "lightweightc"></span><td>
                           <td><span></span></td> 
                        </tr>
                        <tr>
                           <td>Deadweight (kg)</td> 
                           <td><span id = "deadweight"></span></td> 
                           <td><span id = "deadweightc"></span><td>
                           <td><span></span></td> 
                        </tr>
                        <tr>
                           <td>Trim (m)</td> 
                           <td><span id = "trimd"></span></td> 
                           <td><span></span><td>
                           <td><span></span></td> 
                        </tr>
                        <tr>
                           <td>Trim (º)</td> 
                           <td><span id = "trima"></span></td> 
                           <td><span></span><td>
                           <td><span></span></td> 
                        </tr>
                        <tr>
                           <td>Heel (m)</td> 
                           <td><span id = "heel"></span></td> 
                           <td><span></span><td>
                           <td><span></span></td> 
                        </tr>
                        <tr>
                           <td>Maximum moment (ton m)</td> 
                           <td><span id = "maxmom"></span></td> 
                           <td><span></span><td>
                           <td><span></span></td> 
                        </tr>
                        <tr>
                           <td>Shear  (t)</td> 
                           <td><span id = "shear"></span></td> 
                           <td><span></span><td>
                           <td><span></span></td> 
                        </tr>
                        
                    </body>
                
                </table>
			</div>
        </div>
    </div>
        
    <script>
		"use strict";
		
	    // Create scene+
		var renderer, scene, camera, controls, ship3D;
		
		//Ready renderer and scene
        (function (){
			renderer = new THREE.WebGLRenderer({antialias: true});
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setClearColor(0xA9CCE3, 1);

			// get the div that will hold the renderer
			var container = document.getElementById('3d');
			//renderer.setSize(container.clientWidth, container.clientHeight);
			// add the renderer to the div
			container.appendChild(renderer.domElement);
			
			scene = new THREE.Scene();
			
			//Camera and controls:
			camera = new THREE.PerspectiveCamera(50);
			camera.up.set(0,0,1);
			scene.add(camera);
			controls = new THREE.OrbitControls(camera, renderer.domElement);
			
			//Respond to window resize:
			function onResize() {
				renderer.setSize(container.clientWidth, container.clientHeight);
				camera.aspect = container.clientWidth / container.clientHeight;
				camera.updateProjectionMatrix();
			}
			window.addEventListener("resize", onResize);
			onResize(); //Ensure the initial setup is good too
	
			//Add lights:
			scene.add(new THREE.AmbientLight(0xffffff,0.3));
			scene.add(function() {
				let sun = new THREE.DirectionalLight(0xffffff,1);
				sun.position.set(1,1,1);
				return sun;
			}());
			
        })();
				
        // read file from user
        function readSingleFile(e){
            var file = e.target.files[0];
            if (!file) {
                return;
            }
			
            var reader = new FileReader();
            reader.onload = function(e) {
                var contents = e.target.result;
				//call common function for user files and server files
				useFileData(contents);
            }
            reader.readAsText(file);
        }
		
		//Load sample file:
		new THREE.FileLoader().load("data/ship_specifications/blockCase.JSON", useFileData);
		
		function useFileData(contents) {
			var shipspec = JSON.parse(contents);
			displayContents(shipspec);
			var ship = new Vessel.Ship(shipspec);
			if (ship3D !== undefined) {
				scene.remove(ship3D);
			}
			ship3D = new Ship3D(ship, "data/STL files");
			scene.add(ship3D);
			
			let LOA = ship.structure.hull.attributes.LOA;
			camera.position.set(0.7*LOA, 0.7*LOA, 0.7*LOA);
			controls.target = new THREE.Vector3(LOA/2,0,0);
			controls.update();
			animate();
            
            //calculate stability
            let a = ship.calculateStability();
            let GMc = a.GM.toFixed(3);
            document.getElementById("GMc").innerHTML = GMc;
            document.getElementById("GM2").innerHTML = GMc;
            
            //hand values
            let disp = 100;
            let draftms = 2.028;
            let draftap = 2.082;
            let draftfp = 1.974;
            let lwl = 20;
            let bwl = 5.206;
            let Awet = 136.989;
            let Awp = 98.95;
            let Cb = disp / (draftms * lwl * bwl * 1.025);
            let LCBx = 9.636;
            let LCFx = 9.818;
            let KB = 1.319;
            let KG = 3.525;
            let BM = 2.061;
            let GM = KB + BM - KG;
            let trimd = 0.108;
            let trima = 0.618;
            let heel = 0;
            let maxmom = 40.072;
            let shear = 13.327;
            let lightweight = 30000;
            let deadweight = 70000;
            
            document.getElementById("disp").innerHTML = disp.toFixed(3);
            document.getElementById("draftms").innerHTML = draftms.toFixed(3);
            document.getElementById("draftfp").innerHTML = draftfp.toFixed(3);
            document.getElementById("draftap").innerHTML = draftap.toFixed(3);
            document.getElementById("lwl").innerHTML = lwl.toFixed(3);
            document.getElementById("bwl").innerHTML = bwl.toFixed(3);
            document.getElementById("Awet").innerHTML = Awet.toFixed(3);
            document.getElementById("Awp").innerHTML = Awp.toFixed(3);
            document.getElementById("Cb").innerHTML = Cb.toFixed(3);
            document.getElementById("LCBx").innerHTML = LCBx.toFixed(3);
            document.getElementById("LCFx").innerHTML = LCFx.toFixed(3);
            document.getElementById("KB").innerHTML = KB.toFixed(3);
            document.getElementById("KG").innerHTML = KG.toFixed(3);
            document.getElementById("BM").innerHTML = BM.toFixed(3);
            document.getElementById("GM").innerHTML = GM.toFixed(3);
            document.getElementById("trimd").innerHTML = trimd.toFixed(3);
            document.getElementById("trima").innerHTML = trima.toFixed(3);
            document.getElementById("heel").innerHTML = heel.toFixed(3);
            document.getElementById("maxmom").innerHTML = maxmom.toFixed(3);
            document.getElementById("shear").innerHTML = shear.toFixed(3);
            document.getElementById("lightweight").innerHTML = lightweight.toFixed(3);
            document.getElementById("deadweight").innerHTML = deadweight.toFixed(3);
            
            //calculated values
            let KBc = a.KB.toFixed(3);
            let KGc = a.KG.toFixed(3);
            let BMc = a.BM.toFixed(3);
            let draftc = ship.designState.calculationParameters.Draft_design;
            
            //baseObjects not sure why is not working
            let lightweightc = ship.structure.hull.attributes.lightweight + 15000;
            let deadweightc = 14000 + 56000;
            
            
            let lwlc = ship.structure.hull.calculateAttributesAtDraft(draftc).LWL;
            let bwlc = ship.structure.hull.calculateAttributesAtDraft(draftc).BWL;
            let Awpc = ship.structure.hull.calculateAttributesAtDraft(draftc).Awp;
            let cbc = ship.structure.hull.calculateAttributesAtDraft(draftc).Cb;
            let dispc = lwlc * bwlc * cbc * draftc;
            
            document.getElementById("KBc").innerHTML = KBc;
            document.getElementById("KGc").innerHTML = KGc;
            document.getElementById("BMc").innerHTML = BMc;
            document.getElementById("draftc").innerHTML = draftc;
            document.getElementById("lwlc").innerHTML = lwlc.toFixed(3);
            document.getElementById("bwlc").innerHTML = bwlc.toFixed(3);
            document.getElementById("Awpc").innerHTML = Awpc.toFixed(3);
            document.getElementById("cbc").innerHTML = cbc.toFixed(3);
            document.getElementById("lightweightc").innerHTML = lightweightc.toFixed(3);
            document.getElementById("deadweightc").innerHTML = deadweightc.toFixed(3);
            document.getElementById("dispc").innerHTML = dispc.toFixed(3);
            
            //% diff
            let KBd = (1-KB/KBc)*100;
            let KGd = (1-KG/KGc)*100;
            let BMd = (1-BM/BMc)*100;
            let GMd = (1-GM/GMc)*100;
            let draftd = (1-draftms/draftc)*100;
            let lwld = (1-lwl/lwlc)*100;
            let bwld = (1-bwl/bwlc)*100;
            let awpd = (1-Awp/Awpc)*100;
            
            document.getElementById("KBd").innerHTML = KBd.toFixed(3);
            document.getElementById("KGd").innerHTML = KGd.toFixed(3);
            document.getElementById("BMd").innerHTML = BMd.toFixed(3);
            document.getElementById("GMd").innerHTML = GMd.toFixed(3);
            document.getElementById("draftd").innerHTML = draftd.toFixed(3);
            document.getElementById("lwld").innerHTML = lwld.toFixed(3);
            document.getElementById("bwld").innerHTML = bwld.toFixed(3);
            document.getElementById("awpd").innerHTML = awpd.toFixed(3);
            
            
            //console.log(ship.structure.hull.calculateAttributesAtDraft(draftc))
		}
		
		function animate() {
			requestAnimationFrame(animate);			
			renderer.render(scene, camera);
		}
        
        // display pretty JSON
        function displayContents(jsonData) {
			let fileCont = document.getElementById("file-content");
			fileCont.innerHTML = "";
			fileCont.appendChild(
            renderjson(jsonData)
            );
        }
        
        // Catch file browse
        document.getElementById('file-input')
          .addEventListener('change', readSingleFile, false)
        
        //compare values
        
        
        
         
    </script>
    <!-- /.container -->
    
    
    
    <!-- Insert own scripts here -->
      

</body>

</html>